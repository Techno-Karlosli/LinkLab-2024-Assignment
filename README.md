# LinkLab 2024ï¼šæ„å»ºä½ è‡ªå·±çš„é“¾æ¥å™¨

```
 ___       ___  ________   ___  __    ___       ________  ________
|\  \     |\  \|\   ___  \|\  \|\  \ |\  \     |\   __  \|\   __  \
\ \  \    \ \  \ \  \\ \  \ \  \/  /|\ \  \    \ \  \|\  \ \  \|\ /_
 \ \  \    \ \  \ \  \\ \  \ \   ___  \ \  \    \ \   __  \ \   __  \
  \ \  \____\ \  \ \  \\ \  \ \  \\ \  \ \  \____\ \  \ \  \ \  \|\  \
   \ \_______\ \__\ \__\\ \__\ \__\\ \__\ \_______\ \__\ \__\ \_______\
    \|_______|\|__|\|__| \|__|\|__| \|__|\|_______|\|__|\|__|\|_______|
```

> æ¯ä¸ªç¨‹åºå‘˜éƒ½ç”¨è¿‡é“¾æ¥å™¨ï¼Œä½†å¾ˆå°‘æœ‰äººçœŸæ­£ç†è§£å®ƒã€‚
>
> åœ¨è¿™ä¸ªå®éªŒä¸­ï¼Œä½ å°†äº²æ‰‹å®ç°ä¸€ä¸ªé“¾æ¥å™¨ï¼Œæ­å¼€ç¨‹åºæ˜¯å¦‚ä½•è¢«"æ‹¼æ¥"åœ¨ä¸€èµ·çš„ç§˜å¯†ã€‚æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªå‹å¥½çš„ç›®æ ‡æ–‡ä»¶æ ¼å¼ï¼ˆFLEï¼‰ï¼Œè®©ä½ å¯ä»¥ä¸“æ³¨äºç†è§£é“¾æ¥çš„æ ¸å¿ƒæ¦‚å¿µã€‚

> [!WARNING]
> è¿™æ˜¯ LinkLab çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚å¦‚æœä½ ï¼š
>
> - å‘ç°äº† bugï¼Œè¯·[æäº¤ issue](https://github.com/RUCICS/LinkLab-2024-Assignment/issues)ï¼ˆè®°å¾—éµå¾ª issue æ¨¡æ¿ï¼‰
> - æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·åœ¨[è®¨è®ºåŒº](https://github.com/RUCICS/LinkLab-2024-Assignment/discussions)æå‡º
> - æƒ³è¦æ”¹è¿›å®éªŒï¼Œæ¬¢è¿æäº¤ PR
>
> é¢„è®¡è€—æ—¶ï¼š
>
> - åŸºç¡€ä»»åŠ¡ï¼š10-15 å°æ—¶
> - è¿›é˜¶å†…å®¹ï¼š5-10 å°æ—¶
>
> æˆ‘ä»¬ä¼šè®¤çœŸå¯¹å¾…æ¯ä¸€ä¸ªåé¦ˆï¼

[![GitHub Issues](https://img.shields.io/github/issues/RUCICS/LinkLab-2024-Assignment?style=for-the-badge&logo=github)](https://github.com/RUCICS/LinkLab-2024-Assignment/issues)

## ç¯å¢ƒè¦æ±‚

- æ“ä½œç³»ç»Ÿï¼šLinuxï¼ˆæ¨è Ubuntu 22.04 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰
  - Windows ç”¨æˆ·å¯è€ƒè™‘ä½¿ç”¨ WSL 2
- ç¼–è¯‘å™¨ï¼šg++ 12.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆéœ€è¦ C++17ï¼‰
- Python 3.6+
- Makefile
- Git

è¯·ä½¿ç”¨ Git ç®¡ç†ä½ çš„ä»£ç ï¼Œå…»æˆç»å¸¸æäº¤çš„å¥½ä¹ æƒ¯ã€‚

## å¿«é€Ÿå¼€å§‹

```bash
# å…‹éš†ä»“åº“
git clone your-assignment-repo-url
cd your-assignment-repo-name

# æ„å»ºé¡¹ç›®
make

# è¿è¡Œæµ‹è¯•ï¼ˆæ­¤æ—¶åº”è¯¥ä¼šå¤±è´¥ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼‰
make test_1  # è¿è¡Œä»»åŠ¡ä¸€çš„æµ‹è¯•
make test    # è¿è¡Œæ‰€æœ‰æµ‹è¯•
```

## é¡¹ç›®ç»“æ„

```
LinkLab-2024/
â”œâ”€â”€ include/                    # å¤´æ–‡ä»¶
â”‚   â””â”€â”€ fle.hpp                # FLE æ ¼å¼å®šä¹‰ï¼ˆè¯·ä»”ç»†é˜…è¯»ï¼‰
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ base/                  # åŸºç¡€æ¡†æ¶ï¼ˆåŠ©æ•™æä¾›ï¼‰
â”‚   â”‚   â”œâ”€â”€ cc.cpp            # ç¼–è¯‘å™¨å‰ç«¯ï¼Œç”Ÿæˆ FLE æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ exec.cpp          # ç¨‹åºåŠ è½½å™¨ï¼Œè¿è¡Œç”Ÿæˆçš„ç¨‹åº
â”‚   â””â”€â”€ student/              # ä½ éœ€è¦å®Œæˆçš„ä»£ç 
â”‚       â”œâ”€â”€ nm.cpp            # ä»»åŠ¡ä¸€ï¼šç¬¦å·è¡¨æŸ¥çœ‹å™¨
â”‚       â””â”€â”€ ld.cpp            # ä»»åŠ¡äºŒ~å…­ï¼šé“¾æ¥å™¨ä¸»ç¨‹åº
â””â”€â”€ tests/                    # æµ‹è¯•ç”¨ä¾‹
    â””â”€â”€ cases/               # æŒ‰ä»»åŠ¡åˆ†ç±»çš„æµ‹è¯•
        â”œâ”€â”€ 1-nm-test/      # ä»»åŠ¡ä¸€ï¼šç¬¦å·è¡¨æ˜¾ç¤º
        â”œâ”€â”€ 2-ld-test/      # ä»»åŠ¡äºŒï¼šåŸºç¡€é“¾æ¥
        â””â”€â”€ ...             # æ›´å¤šæµ‹è¯•ç”¨ä¾‹
    â””â”€â”€ common/              # æµ‹è¯•ç”¨ä¾‹çš„å…¬å…±åº“
        â””â”€â”€ minilibc.c       # è¿·ä½  libc çš„å®ç°
```

æ¯ä¸ªä»»åŠ¡éƒ½é…æœ‰å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼ŒåŒ…æ‹¬ï¼š

- æºä»£ç ï¼šç”¨äºç”Ÿæˆæµ‹è¯•è¾“å…¥
- æœŸæœ›è¾“å‡ºï¼šç”¨äºéªŒè¯ä½ çš„å®ç°
- é…ç½®æ–‡ä»¶ï¼šå®šä¹‰æµ‹è¯•å‚æ•°

ä½ å¯ä»¥ï¼š

1. é˜…è¯»æµ‹è¯•ä»£ç äº†è§£å…·ä½“è¦æ±‚
2. è¿è¡Œæµ‹è¯•æ£€æŸ¥å®ç°æ˜¯å¦æ­£ç¡®
3. ä¿®æ”¹æµ‹è¯•æ¢ç´¢æ›´å¤šå¯èƒ½æ€§

## ä»»åŠ¡é›¶ï¼šç†è§£ç›®æ ‡æ–‡ä»¶æ ¼å¼

åœ¨å¼€å§‹å†™é“¾æ¥å™¨ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£å®ƒå¤„ç†çš„æ–‡ä»¶æ ¼å¼ã€‚ä¼ ç»Ÿçš„ ELF æ ¼å¼è™½ç„¶å¼ºå¤§ï¼Œä½†ç»†èŠ‚å¤ªå¤šã€‚ä¸ºäº†è®©ä½ ä¸“æ³¨äºé“¾æ¥çš„æ ¸å¿ƒæ¦‚å¿µï¼Œæˆ‘ä»¬è®¾è®¡äº† FLE (Friendly Linking Executable) æ ¼å¼ã€‚

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥äº†è§£å®ƒï¼š

```c
// test.c
int message[2] = {1, 2};  // å…¨å±€æ•°ç»„

static int helper(int x) { // é™æ€å‡½æ•°
    return x + message[0];
}

int main() {             // ç¨‹åºå…¥å£
    return helper(42);
}
```

é€šè¿‡ `./cc test.c -o test.o`ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ª FLE æ–‡ä»¶ï¼š

```json5
{
    "type": ".obj", // è¿™æ˜¯ä¸€ä¸ªç›®æ ‡æ–‡ä»¶
    "shdrs": [
        // å„ä¸ªèŠ‚çš„å…ƒæ•°æ®
        {
            "name": ".text", // èŠ‚å
            "type": 1, // èŠ‚ç±»å‹
            "flags": 1, // èŠ‚æƒé™
            "addr": 0, // èŠ‚åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€
            "offset": 0, // èŠ‚åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡
            "size": 36  // èŠ‚çš„å¤§å°
        },
        {
            "name": ".data",
            "type": 1,
            "flags": 1,
            "addr": 0,
            "offset": 0,
            "size": 8
        },
        {
            "name": ".bss",
            "type": 8,
            "flags": 9,
            "addr": 0,
            "offset": 0,
            "size": 0
        }
    ],
    ".text": [
        "ğŸ·ï¸: helper 20 0", // å±€éƒ¨ç¬¦å·
        "ğŸ”¢: 55 48 89 e5 89 7d fc 8b 15", // æœºå™¨ç 
        "â“: .rel(message - 4)", // éœ€è¦é‡å®šä½
        "ğŸ”¢: 8b 45 fc 01 d0 5d c3", // æœºå™¨ç 
        "ğŸ“¤: main 16 20", // å…¨å±€ç¬¦å·
        "ğŸ”¢: 55 48 89 e5 bf 2a 00 00 00 e8 de ff ff ff 5d c3" // æœºå™¨ç 
    ],
    ".data": [
        "ğŸ“¤: message 8 0", // å…¨å±€ç¬¦å·
        "ğŸ”¢: 01 00 00 00 02 00 00 00" // æ•°æ®
    ],
    ".bss": []
}
```

FLE ä½¿ç”¨è¡¨æƒ…ç¬¦å·æ¥æ ‡è®°ä¸åŒç±»å‹çš„ä¿¡æ¯ï¼š

1. æœºå™¨ç ï¼šåå…­è¿›åˆ¶è¡¨ç¤º
  - ğŸ”¢ åŸå§‹çš„æœºå™¨ç æˆ–æ•°æ®
2. ç¬¦å·ï¼š`ç±»å‹: ç¬¦å·å å¤§å° èŠ‚å†…åç§»é‡`
  - ğŸ·ï¸ æ–‡ä»¶å†…éƒ¨çš„å±€éƒ¨ç¬¦å·
  - ğŸ“¤ å¯ä»¥è¢«å…¶ä»–æ–‡ä»¶å¼•ç”¨çš„å…¨å±€ç¬¦å·
  - ğŸ“ å¯ä»¥è¢«è¦†ç›–çš„å¼±ç¬¦å·
3. é‡å®šä½ï¼š`â“: é‡å®šä½ç±»å‹(ç›®æ ‡ç¬¦å·å [+/-] é™„åŠ å€¼)`
  - â“ éœ€è¦é‡å®šä½çš„åœ°æ–¹

è¿™äº›ä¿¡æ¯åœ¨å†…å­˜ä¸­ç”¨ C++ ç»“æ„ä½“è¡¨ç¤ºï¼ˆå®šä¹‰åœ¨ [`include/fle.hpp`](include/fle.hpp) ä¸­ï¼‰ï¼š

```cpp
struct FLEObject {
    std::string type;                           // æ–‡ä»¶ç±»å‹ï¼ˆ.obj/.exeï¼‰
    std::map<std::string, FLESection> sections; // å„ä¸ªèŠ‚
    std::vector<Symbol> symbols;                // ç¬¦å·è¡¨
    std::vector<ProgramHeader> phdrs;           // ç¨‹åºå¤´
    std::vector<SectionHeader> shdrs;           // èŠ‚å¤´
    size_t entry = 0;                           // å…¥å£ç‚¹ï¼ˆä»…å¯æ‰§è¡Œæ–‡ä»¶ï¼‰
};

struct FLESection {
    std::vector<uint8_t> data;      // èŠ‚æ•°æ®ï¼ˆæŒ‰å­—èŠ‚å­˜å‚¨ï¼‰
    std::vector<Relocation> relocs; // é‡å®šä½è¡¨
    bool has_symbols;               // æ˜¯å¦åŒ…å«ç¬¦å·
};

// å…¶ä»–ç»“æ„ä½“å®šä¹‰è¯·å‚è€ƒ include/fle.hppï¼Œæ­¤å¤„ç•¥
```

æˆ‘ä»¬çš„å®éªŒæ¡†æ¶ä¼šè‡ªåŠ¨å°† FLE æ–‡ä»¶åŠ è½½ä¸ºå†…å­˜ä¸­çš„æ•°æ®ç»“æ„ `FLEObject`ã€‚

> [!IMPORTANT]
> FLE æ–‡ä»¶çš„æ ¼å¼å’Œ `FLEObject` ä¸­çš„è¡¨ç¤ºï¼Œè™½ç„¶å¤§éƒ¨åˆ†å†…å®¹æ˜¯å¯¹åº”çš„ï¼Œä½†å…¶ä¸­èŠ‚æ•°æ®çš„è¡¨ç¤ºæ˜¯ä¸åŒçš„ã€‚FLE æ–‡ä»¶æ›´å¼ºè°ƒå¯è¯»æ€§ï¼Œè€Œ `FLEObject` åˆ™æ›´ç±»ä¼¼æ ‡å‡†çš„ ELF æ ¼å¼ã€‚å…·ä½“æ¥è¯´ï¼š
>
> - åœ¨ FLE æ–‡ä»¶ä¸­ï¼Œé‡å®šä½å’Œç¬¦å·å®šä¹‰æ˜¯å†…è”çš„ã€‚ç¬¦å·å®šä¹‰çš„åœ°æ–¹ç›´æ¥ç”¨ ğŸ“¤/ğŸ“/ğŸ·ï¸ æ ‡è®°ã€‚ä½† `FLEObject` ä¸­æœ‰å•ç‹¬çš„ç¬¦å·è¡¨ï¼Œåœ¨æ¯ä¸ª `FLESection` ä¸­åˆ™æœ‰å•ç‹¬çš„é‡å®šä½è¡¨ã€‚
> - åœ¨ FLE æ–‡ä»¶ä¸­ï¼Œæ²¡æœ‰å ä½å­—èŠ‚ï¼Œéœ€è¦é‡å®šä½çš„åœ°æ–¹ç›´æ¥ç”¨ â“ æ ‡è®°ã€‚ä½†åœ¨æ¯ä¸ª `FLESection` çš„ `data` å­—æ®µä¸­ï¼Œéœ€è¦é‡å®šä½çš„åœ°æ–¹ä¼šç”¨ 0 å ä½ã€‚
>
> å¯¹äºä½ æ¥è¯´ï¼Œåœ¨å®ç°é“¾æ¥å™¨æ—¶ï¼Œå¯èƒ½æ›´å¤šéœ€è¦å…³æ³¨ `FLEObject` ä¸­çš„è¡¨ç¤ºã€‚FLE æ–‡ä»¶çš„æ ¼å¼ä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹å’Œè°ƒè¯•ã€‚

èŠ‚å¤´ï¼ˆsection headersï¼‰æ˜¯ç›®æ ‡æ–‡ä»¶ä¸­çš„é‡è¦å…ƒæ•°æ®ï¼Œå®ƒæè¿°äº†æ¯ä¸ªèŠ‚çš„å±æ€§å’Œä½ç½®ä¿¡æ¯ã€‚åœ¨æˆ‘ä»¬çš„ FLE æ ¼å¼ä¸­ï¼Œæ¯ä¸ªèŠ‚å¤´åŒ…å«ï¼š

- `name`ï¼šèŠ‚çš„åç§°ï¼ˆå¦‚ `.text`ã€`.data` ç­‰ï¼‰
- `type`ï¼šèŠ‚çš„ç±»å‹ï¼ˆå¦‚ä»£ç ã€æ•°æ®ç­‰ï¼‰
- `flags`ï¼šèŠ‚çš„å±æ€§æ ‡å¿—
- `addr`ï¼šèŠ‚åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€
- `offset`ï¼šèŠ‚åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡
- `size`ï¼šèŠ‚çš„å¤§å°

è¿™äº›ä¿¡æ¯å¯¹é“¾æ¥å™¨æ¥è¯´éå¸¸é‡è¦ â€”â€” å®ƒä»¬æè¿°äº†ç›®æ ‡æ–‡ä»¶ä¸­å„ä¸ªèŠ‚çš„ç»„ç»‡æ–¹å¼ã€‚é“¾æ¥å™¨éœ€è¦ä½¿ç”¨è¿™äº›ä¿¡æ¯æ¥ï¼š
1. å®šä½å’Œè¯»å–å„ä¸ªèŠ‚çš„å†…å®¹
2. åˆå¹¶æ¥è‡ªä¸åŒæ–‡ä»¶çš„åŒç±»å‹èŠ‚
3. åœ¨ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶ç¡®å®šæœ€ç»ˆçš„å†…å­˜å¸ƒå±€

> [!NOTE]
> åœ¨ ELF æ ¼å¼ä¸­ï¼Œæœ‰ä¸¤ç§ä¸åŒçš„è§†å›¾ï¼š
> - é“¾æ¥è§†å›¾ï¼šç”±èŠ‚å¤´è¡¨ï¼ˆSection Headersï¼‰æè¿°ï¼ŒåŒ…å«äº†é“¾æ¥æ—¶éœ€è¦çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ `.text`ã€`.data`ã€`.bss` ç­‰èŠ‚
> - è¿è¡Œè§†å›¾ï¼šç”±ç¨‹åºå¤´è¡¨ï¼ˆProgram Headersï¼‰æè¿°ï¼Œå®šä¹‰äº†ç¨‹åºè¿è¡Œæ—¶çš„å†…å­˜æ®µï¼ˆsegmentï¼‰
>
> åœ¨æ ‡å‡†çš„ ELF ä¸­ï¼Œä¸€ä¸ªå†…å­˜æ®µé€šå¸¸ä¼šåŒ…å«å¤šä¸ªå…·æœ‰ç›¸åŒæƒé™éœ€æ±‚çš„èŠ‚ã€‚ä¾‹å¦‚ï¼Œå¯è¯»å†™çš„æ•°æ®æ®µé€šå¸¸åŒæ—¶åŒ…å« `.data` å’Œ `.bss` èŠ‚ï¼Œå®ƒä»¬ä¼šè¢«æ˜ å°„åˆ°åŒä¸€å—è¿ç»­çš„å†…å­˜åŒºåŸŸä¸­ã€‚è¿™ç§è®¾è®¡å¯ä»¥å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œç®€åŒ–ç¨‹åºçš„åŠ è½½è¿‡ç¨‹ã€‚
>
> ä¸ºäº†è®©åŒå­¦ä»¬ä¸“æ³¨äºç†è§£é“¾æ¥çš„åŸºæœ¬æ¦‚å¿µï¼Œæˆ‘ä»¬çš„ FLE æ ¼å¼é‡‡ç”¨äº†ç®€åŒ–çš„è®¾è®¡ï¼š
> - åœ¨ä»»åŠ¡å…­ä¹‹å‰ï¼Œæ‰€æœ‰å†…å®¹éƒ½æ”¾åœ¨ä¸€ä¸ªåä¸º `.load` çš„èŠ‚ä¸­
> - åœ¨ä»»åŠ¡å…­ä¸­ï¼Œæˆ‘ä»¬å°†ä»£ç å’Œæ•°æ®åˆ†å¼€æ”¾å…¥ä¸åŒçš„èŠ‚ï¼ˆ`.text`ã€`.data` ç­‰ï¼‰
> - ä½†å§‹ç»ˆä¿æŒèŠ‚å’Œæ®µçš„ä¸€å¯¹ä¸€æ˜ å°„ï¼šæ¯ä¸ªèŠ‚éƒ½è¢«å•ç‹¬æ˜ å°„ä¸ºä¸€ä¸ªå†…å­˜æ®µ
>
> è¿™ç§ç®€åŒ–è™½ç„¶ä¸å¤Ÿä¼˜åŒ–ï¼Œä½†æ›´å®¹æ˜“ç†è§£å’Œå®ç°ã€‚åœ¨å®Œæˆå®éªŒåï¼Œä½ ä¼šå¯¹è¿™ä¸¤ç§è§†å›¾éƒ½æœ‰æ·±å…¥çš„è®¤è¯†ã€‚

åœ¨æ¥ä¸‹æ¥çš„ä»»åŠ¡ä¸­ï¼Œä½ å°†é€æ­¥å®ç°å¤„ç†è¿™ç§æ ¼å¼çš„å·¥å…·é“¾ï¼Œä»æœ€åŸºæœ¬çš„ç¬¦å·è¡¨æŸ¥çœ‹å™¨å¼€å§‹ï¼Œæœ€ç»ˆå®ç°ä¸€ä¸ªå®Œæ•´çš„é“¾æ¥å™¨ã€‚

å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼

## ä»»åŠ¡ä¸€ï¼šçª¥æ¢ç¨‹åºçš„ç¬¦å·è¡¨

ä½ æœ‰æ²¡æœ‰é‡åˆ°è¿‡è¿™æ ·çš„é”™è¯¯ï¼Ÿ

```
undefined reference to `printf'
multiple definition of `main'
```

è¿™äº›éƒ½ä¸ç¬¦å·ï¼ˆsymbolï¼‰æœ‰å…³ã€‚ç¬¦å·å°±åƒç¨‹åºä¸­çš„"åå­—"ï¼Œä»£è¡¨äº†å‡½æ•°ã€å˜é‡ç­‰ã€‚è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ç†è§£ï¼š

```c
static int counter = 0;        // é™æ€å˜é‡ï¼šæ–‡ä»¶å†…å¯è§
int shared = 42;              // å…¨å±€å˜é‡ï¼šå…¶ä»–æ–‡ä»¶å¯è§
extern void print(int x);     // å¤–éƒ¨å‡½æ•°ï¼šéœ€è¦å…¶ä»–æ–‡ä»¶æä¾›

void count() {                // å…¨å±€å‡½æ•°
    counter++;                // è®¿é—®é™æ€å˜é‡
    print(counter);           // è°ƒç”¨å¤–éƒ¨å‡½æ•°
}
```

è¿™æ®µä»£ç ä¸­åŒ…å«äº†å‡ ç§ä¸åŒçš„ç¬¦å·ï¼š

- `counter`ï¼šé™æ€ç¬¦å·ï¼Œåªåœ¨æ–‡ä»¶å†…å¯è§
- `shared`ï¼šå…¨å±€ç¬¦å·ï¼Œå¯ä»¥è¢«å…¶ä»–æ–‡ä»¶å¼•ç”¨
- `print`ï¼šæœªå®šä¹‰ç¬¦å·ï¼Œéœ€è¦åœ¨é“¾æ¥æ—¶æ‰¾åˆ°ï¼ˆä½†ä¸ºæ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å¿½ç•¥æ‰€æœ‰æœªå®šä¹‰ç¬¦å·ï¼Œæ‰€ä»¥ä¸éœ€è¦å¤„ç†ï¼‰
- `count`ï¼šå…¨å±€å‡½æ•°ç¬¦å·

ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯è¡¥å…… [src/student/nm.cpp](src/student/nm.cpp) ä¸­çš„ `FLE_nm` æ–¹æ³•ï¼Œå®ç°ä¸€ä¸ªå·¥å…·ï¼ˆnmï¼‰æ¥æŸ¥çœ‹è¿™äº›ç¬¦å·ã€‚å¯¹äºä¸Šé¢çš„ä»£ç ï¼Œå®ƒåº”è¯¥è¾“å‡ºï¼š

```
0000000000000000 T count    # å…¨å±€å‡½æ•°åœ¨ .text èŠ‚
0000000000000000 b counter  # é™æ€å˜é‡åœ¨ .bss èŠ‚
0000000000000000 D shared   # å…¨å±€å˜é‡åœ¨ .data èŠ‚
```

æ¯ä¸€è¡ŒåŒ…å«ï¼š

- åœ°å€ï¼šç¬¦å·åœ¨å…¶æ‰€åœ¨èŠ‚ä¸­çš„åç§»é‡
- ç±»å‹ï¼šè¡¨ç¤ºç¬¦å·çš„ç±»å‹å’Œä½ç½®
  - å¤§å†™ï¼ˆTã€Dã€Bã€Rï¼‰ï¼šå…¨å±€ç¬¦å·ï¼Œåˆ†åˆ«è¡¨ç¤ºåœ¨ä»£ç æ®µã€æ•°æ®æ®µã€BSS æ®µã€åªè¯»æ•°æ®æ®µ
  - å°å†™ï¼ˆtã€dã€bã€rï¼‰ï¼šå±€éƒ¨ç¬¦å·ï¼Œåˆ†åˆ«è¡¨ç¤ºåœ¨ä»£ç æ®µã€æ•°æ®æ®µã€BSS æ®µã€åªè¯»æ•°æ®æ®µ
  - Wã€Vï¼šå¼±ç¬¦å·ï¼Œåˆ†åˆ«è¡¨ç¤ºåœ¨ä»£ç æ®µã€è¿˜æ˜¯åœ¨æ•°æ®æ®µæˆ– BSS æ®µ
- åç§°ï¼šç¬¦å·çš„åå­—

è¦å®ç°è¿™ä¸ªå·¥å…·ï¼Œä½ éœ€è¦ï¼š

1. éå†ç¬¦å·è¡¨
2. ç¡®å®šæ¯ä¸ªç¬¦å·çš„ç±»å‹
3. æŒ‰æ ¼å¼æ‰“å°ä¿¡æ¯

æç¤ºï¼š

- ä½¿ç”¨ `std::setw` å’Œ `std::setfill` æ ¼å¼åŒ–è¾“å‡º
- æ ¹æ® section å­—æ®µåˆ¤æ–­ç¬¦å·ä½ç½®
- æœªå®šä¹‰ç¬¦å·çš„ section ä¸ºç©º

### éªŒè¯

è¿è¡Œæµ‹è¯•ï¼š

```bash
make test_1
```

## ä»»åŠ¡äºŒï¼šå®ç°åŸºç¡€é“¾æ¥å™¨

è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­å¼€å§‹ç†è§£é“¾æ¥å™¨çš„å·¥ä½œåŸç†ã€‚å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªç¨‹åºï¼š

```c
// foo.c
const char str[] = "Hello, World!";  // ä¸€ä¸ªå…¨å±€å­—ç¬¦ä¸²å¸¸é‡

// main.c
extern const char str[];  // å£°æ˜ï¼šstr åœ¨åˆ«å¤„å®šä¹‰

void _start()
{
    int ans = 0;
    for (int i = 0; i < 10; i++) {
        ans += str[i];  // éœ€è¦æ‰¾åˆ° str çš„å®é™…ä½ç½®
    }
    // ... é€€å‡ºç³»ç»Ÿè°ƒç”¨ ...
}
```

ç¼–è¯‘å™¨ä¼šå°†è¿™äº›æºæ–‡ä»¶ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ã€‚åœ¨æˆ‘ä»¬çš„ FLE æ ¼å¼ä¸­ï¼Œç›®æ ‡æ–‡ä»¶æœ‰ä¸¤ç§è¡¨ç¤ºå½¢å¼ï¼šç£ç›˜ä¸Šçš„ JSON æ ¼å¼å’Œå†…å­˜ä¸­çš„æ•°æ®ç»“æ„ã€‚ä»¥ `foo.fle` ä¸ºä¾‹ï¼Œå®ƒåœ¨ç£ç›˜ä¸Šçš„ JSON æ ¼å¼æ˜¯ï¼š

```json5
{
    "type": ".obj",
    "shdrs": [ /* ... èŠ‚å¤´ï¼ˆç•¥ï¼‰ ... */ ],
    ".text": [],
    ".rodata": [
        "ğŸ“¤: str 14 0",    // å®šä¹‰ä¸€ä¸ªå…¨å±€ç¬¦å· strï¼Œå¤§å°ä¸º 14 å­—èŠ‚
        "ğŸ”¢: 48 65 6c 6c 6f 2c 20 57 6f 72 6c 64 21 00"   // "Hello, World!"çš„å­—èŠ‚è¡¨ç¤º
    ]
}
```

å½“è¿™ä¸ªæ–‡ä»¶è¢«åŠ è½½åˆ°å†…å­˜æ—¶ï¼Œå®ƒä¼šè¢«è§£ææˆä¸€ä¸ª `FLEObject` ç»“æ„ã€‚å…¶ä¸­ç¬¦å· `str` ä¼šè¢«è§£æä¸ºä¸€ä¸ª `Symbol` ç»“æ„ï¼š

```cpp
Symbol {
    .type = SymbolType::GLOBAL,  // å¯¹åº”æ–‡ä»¶ä¸­çš„ ğŸ“¤
    .section = ".rodata",        // ç¬¦å·æ‰€åœ¨çš„èŠ‚
    .offset = 0,                 // åœ¨èŠ‚å†…çš„åç§»
    .size = 14,                  // ç¬¦å·å¤§å°
    .name = "str"                // ç¬¦å·åç§°
}
```

è€Œ `.rodata` èŠ‚çš„å†…å®¹ä¼šè¢«å­˜å‚¨åœ¨ `FLESection` ç»“æ„ä¸­ï¼š

```cpp
FLESection {
    .data = { 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x57, 
              0x6f, 0x72, 0x6c, 0x64, 0x21, 0x00 }  // "Hello, World!"
}
```

ç±»ä¼¼åœ°ï¼Œ`main.fle` åœ¨ç£ç›˜ä¸Šçš„è¡¨ç¤ºæ˜¯ï¼š

```json5
{
    "type": ".obj",
    ".text": [
        "ğŸ“¤: _start 63 0",    // å®šä¹‰ä¸€ä¸ªå…¨å±€ç¬¦å· _start
        "ğŸ”¢: 55 48 89 e5 c7 45 fc 00 00 00 00 c7 45 f8 00 00",  // æœºå™¨ç 
        "ğŸ”¢: 00 00 eb 16 8b 45 f8 48 98 0f b6 80",
        "â“: .abs32s(str + 0)",  // éœ€è¦é‡å®šä½ï¼šå¡«å…¥ str çš„åœ°å€
        "ğŸ”¢: 0f be c0 01 45 fc 83 45 f8 01 83 7d f8 09 7e e4",
        "ğŸ”¢: 8b 55 fc 89 d7 b8 3c 00 00 00 0f 05 90 5d c3"
    ]
}
```

å…¶ä¸­çš„é‡å®šä½ä¿¡æ¯ä¼šè¢«è§£ææˆ `Relocation` ç»“æ„ï¼š

```cpp
Relocation {
    .type = RelocationType::R_X86_64_32S,  // 32ä½æœ‰ç¬¦å·ç»å¯¹å¯»å€
    .offset = 28,                          // é‡å®šä½åœ¨èŠ‚å†…çš„ä½ç½®
    .symbol = "str",                       // ç›®æ ‡ç¬¦å·
    .addend = 0                            // åç§»é‡
}
```

åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬é‡‡ç”¨æœ€ç®€å•çš„æ–¹æ¡ˆï¼šå°†æ‰€æœ‰å†…å®¹åˆå¹¶åˆ°ä¸€ä¸ªå« `.load` çš„èŠ‚ä¸­ã€‚è¿™ä¸çœŸå®çš„å¯æ‰§è¡Œæ–‡ä»¶æœ‰æ‰€ä¸åŒ â€”â€” å®é™…çš„å¯æ‰§è¡Œæ–‡ä»¶é€šå¸¸ä¼šå°†ä»£ç ï¼ˆ`.text`ï¼‰ã€æ•°æ®ï¼ˆ`.data`ï¼‰ç­‰æ”¾åœ¨ä¸åŒçš„èŠ‚ä¸­ï¼Œå¹¶èµ‹äºˆå®ƒä»¬ä¸åŒçš„æƒé™ã€‚ä½†ä¸ºäº†ç®€åŒ–é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæŠŠæ‰€æœ‰å†…å®¹æ”¾åœ¨ä¸€ä¸ªèŠ‚ä¸­ã€‚

é“¾æ¥å™¨éœ€è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼š

é¦–å…ˆï¼Œå°†æ‰€æœ‰ç›®æ ‡æ–‡ä»¶ä¸­çš„èŠ‚ï¼ˆ`.text`ã€`.rodata` ç­‰ï¼‰æŒ‰é¡ºåºåˆå¹¶åˆ° `.load` èŠ‚ä¸­ã€‚åœ¨åˆå¹¶çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦è®°å½•æ¯ä¸ªç¬¦å·åœ¨åˆå¹¶åçš„æ–°ä½ç½®ã€‚æ¯”å¦‚ `str` ç¬¦å·åŸæœ¬åœ¨ `foo.fle` çš„ `.rodata` èŠ‚å¼€å¤´ï¼Œåˆå¹¶åå®ƒçš„ä½ç½®éœ€è¦åŠ ä¸Šä¸€ä¸ªåç§»é‡ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šæ›´æ–°å†…å­˜ä¸­ `Symbol` ç»“æ„çš„ `offset` å­—æ®µã€‚

æ¥ç€ï¼Œå¤„ç†æ‰€æœ‰çš„é‡å®šä½é¡¹ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ`main.fle` ä¸­æœ‰ä¸€ä¸ªå¯¹ `str` çš„å¼•ç”¨éœ€è¦é‡å®šä½ã€‚

> [!IMPORTANT]
> åœ¨å¤„ç†ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨æ—¶ï¼Œä½ ä¼šå‘ç°å•ä¸ªç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä¸­å¯èƒ½åŒ…å«æœªå®šä¹‰ç¬¦å·ï¼ˆå³åœ¨å½“å‰æ–‡ä»¶ä¸­è¢«å¼•ç”¨ä½†å°šæœªå®šä¹‰çš„ç¬¦å·ï¼‰ã€‚è¿™ä¸æ ‡å‡† ELF æ ¼å¼çš„è¡Œä¸ºæ˜¯ä¸€è‡´çš„ã€‚å¤„ç†è¿™äº›ç¬¦å·æ—¶ï¼š
> - ä¸è¦ç«‹å³æŠ¥å‘Šæœªå®šä¹‰é”™è¯¯
> - åœ¨åç»­çš„ç›®æ ‡æ–‡ä»¶ä¸­ç»§ç»­æŸ¥æ‰¾è¯¥ç¬¦å·çš„å®šä¹‰
> - åªæœ‰åœ¨å¤„ç†å®Œæ‰€æœ‰ç›®æ ‡æ–‡ä»¶åï¼Œä»ç„¶æ‰¾ä¸åˆ°å®šä¹‰æ—¶æ‰æŠ¥é”™
>
> è¿™ç§æœºåˆ¶å…è®¸ç›®æ ‡æ–‡ä»¶ä¹‹é—´ç›¸äº’å¼•ç”¨ï¼Œä¸è¦æ±‚ç¬¦å·å®šä¹‰å¿…é¡»å‡ºç°åœ¨å¼•ç”¨ä¹‹å‰ã€‚

åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬åªéœ€è¦å¤„ç† `R_X86_64_32` å’Œ `R_X86_64_32S` ç±»å‹çš„é‡å®šä½ â€”â€” å®ƒä»¬éƒ½æ˜¯å°†ç¬¦å·çš„ç»å¯¹åœ°å€å¡«å…¥é‡å®šä½ä½ç½®ã€‚

> [!TIP]
> `R_X86_64_32` å’Œ `R_X86_64_32S` éƒ½ä¼šå°† 64 ä½åœ°å€æˆªæ–­ä¸º 32 ä½ï¼ŒåŒºåˆ«åœ¨äºé“¾æ¥å™¨å¦‚ä½•éªŒè¯è¿™ä¸ªæˆªæ–­æ˜¯å¦åˆæ³•ï¼š
> - `R_X86_64_32`ï¼šè¦æ±‚æˆªæ–­æ‰çš„é«˜ 32 ä½å¿…é¡»ä¸º 0ï¼Œè¿™æ ·é€šè¿‡é›¶æ‰©å±•å¯ä»¥è¿˜åŸå‡ºåŸå§‹çš„ 64 ä½å€¼
> - `R_X86_64_32S`ï¼šè¦æ±‚é«˜ 32 ä½çš„å€¼ä¸æˆªæ–­åçš„ç¬¦å·ä½ï¼ˆå³ç¬¬ 32 ä½ï¼‰ç›¸åŒï¼ˆå…¨ 0 æˆ–å…¨ 1ï¼‰ï¼Œè¿™æ ·æ‰èƒ½é€šè¿‡ç¬¦å·æ‰©å±•è¿˜åŸå‡ºåŸå§‹çš„ 64 ä½å€¼

é“¾æ¥å™¨éœ€è¦ï¼š
1. åœ¨åˆå¹¶åçš„ç¬¦å·è¡¨ä¸­æŸ¥æ‰¾ `str` ç¬¦å·ï¼Œå¾—åˆ°å…¶æœ€ç»ˆåœ°å€ï¼ˆåŸºåœ°å€ + èŠ‚åç§» + ç¬¦å·åç§»ï¼‰
2. å°†è¿™ä¸ªåœ°å€åŠ ä¸Š `addend`ï¼ˆ0ï¼‰å¾—åˆ°æœ€ç»ˆå€¼
3. æ ¹æ®é‡å®šä½ç±»å‹ï¼ˆ`R_X86_64_32S`ï¼‰å°†è¿™ä¸ªå€¼æˆªæ–­ä¸º 32 ä½
4. å°†è®¡ç®—å¾—åˆ°çš„å€¼å†™å…¥åˆ°éœ€è¦é‡å®šä½çš„ä½ç½®ï¼ˆåœ¨é‡å®šä½è¡¨ä¸­æŒ‡å®šçš„åç§»é‡å¤„ï¼‰

ä¾‹å¦‚ï¼Œå¦‚æœ `str` æœ€ç»ˆä½äºåœ°å€ 0x401000ï¼Œé‚£ä¹ˆï¼š
- æœ€ç»ˆå€¼ = 0x401000 + 0 = 0x401000
- æˆªæ–­ä¸º 32 ä½å = 0x401000 & 0xFFFFFFFF = 0x401000
- éªŒè¯æˆªæ–­åçš„å€¼æ˜¯å¦åˆæ³•
- å°† 0x401000 å†™å…¥é‡å®šä½ä½ç½®

æœ€åï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚åœ¨å†…å­˜ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ `FLEObject`ï¼Œè®¾ç½®å…¶ `type` ä¸º `.exe`ï¼Œå¹¶ç”Ÿæˆæ­£ç¡®çš„ç¨‹åºå¤´ï¼ˆ`ProgramHeader` ç»“æ„ï¼‰ä»¥ä¾¿åŠ è½½å™¨èƒ½å¤Ÿæ­£ç¡®åœ°åŠ è½½ç¨‹åºã€‚

åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬åªç”Ÿæˆä¸€ä¸ªç¨‹åºå¤´æ¥æè¿° `.load` æ®µã€‚å®ƒéœ€è¦æŒ‡å®šï¼š
- æ®µåï¼ˆnameï¼‰ï¼š`.load`
- åŠ è½½åœ°å€ï¼ˆvaddrï¼‰ï¼šæˆ‘ä»¬ä½¿ç”¨ 0x400000
- æ®µçš„å¤§å°ï¼ˆsizeï¼‰ï¼šåˆå¹¶åçš„æ€»å¤§å°
- æƒé™æ ‡å¿—ï¼ˆflagsï¼‰ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬ç®€å•åœ°èµ‹äºˆ RWXï¼ˆå¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œï¼‰æƒé™ï¼ˆ0b111ï¼Œå³åè¿›åˆ¶çš„ 7ï¼‰

> [!IMPORTANT]
> æ³¨æ„ç¨‹åºå¤´ï¼ˆProgram Headersï¼‰å’ŒèŠ‚å¤´ï¼ˆSection Headersï¼‰çš„åŒºåˆ«ï¼š
> - èŠ‚å¤´ï¼ˆSection Headersï¼‰æè¿°äº†æ–‡ä»¶ä¸­å„ä¸ªèŠ‚çš„å±æ€§ï¼Œä¸»è¦ç”¨äºé“¾æ¥å’Œè°ƒè¯•ã€‚
> - ç¨‹åºå¤´ï¼ˆProgram Headersï¼‰æè¿°äº†ç¨‹åºè¿è¡Œæ—¶å¦‚ä½•å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ï¼Œæ˜¯åŠ è½½ç¨‹åºï¼ˆloaderï¼‰å¿…éœ€çš„ä¿¡æ¯ã€‚
>
> åœ¨æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼ŒèŠ‚å¤´å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œç¨‹åºå¤´æ˜¯å¿…é¡»çš„ã€‚

æ­¤å¤–ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å¿…é¡»æŒ‡å®šä¸€ä¸ªå…¥å£ç‚¹ï¼ˆentry pointï¼‰ï¼Œä¹Ÿå°±æ˜¯ç¨‹åºå¼€å§‹æ‰§è¡Œçš„ä½ç½®ã€‚åœ¨ x86-64 ç¨‹åºä¸­ï¼Œè¿™ä¸ªå…¥å£ç‚¹é€šå¸¸æ˜¯åä¸º `_start` çš„å‡½æ•°ã€‚é“¾æ¥å™¨éœ€è¦åœ¨åˆå¹¶åçš„ç¬¦å·è¡¨ä¸­æ‰¾åˆ° `_start` ç¬¦å·ï¼Œå¹¶å°†å…¶åœ°å€ï¼ˆåŸºåœ°å€ + ç¬¦å·åç§»ï¼‰è®¾ç½®ä¸ºç¨‹åºçš„å…¥å£ç‚¹ã€‚å¦‚æœæ‰¾ä¸åˆ° `_start` ç¬¦å·ï¼Œåº”è¯¥æŠ¥é”™ï¼Œå› ä¸ºè¿™æ„å‘³ç€ç¨‹åºç¼ºå°‘å¿…éœ€çš„å…¥å£ç‚¹ã€‚

åœ¨å®Œæˆè¿™äº›å·¥ä½œåï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„ `FLEObject` ç»“æ„ä½“ï¼Œå®ƒæè¿°äº†æ•´ä¸ªç¨‹åºçš„å†…å­˜å¸ƒå±€å’Œæ‰§è¡Œæµç¨‹ã€‚åœ¨ `FLE_ld` æ–¹æ³•è¿”å›è¿™ä¸ªç»“æ„ä½“åï¼Œæˆ‘ä»¬çš„å®éªŒæ¡†æ¶ä¼šå°†å…¶åºåˆ—åŒ–ä¸º JSON æ ¼å¼çš„ FLE æ–‡ä»¶ï¼š

```json5
{
    "type": ".exe",           // è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶
    "phdrs": [{               // ç¨‹åºå¤´
        "name": ".load",
        "vaddr": 0x400000,    // å›ºå®šçš„åŠ è½½åœ°å€
        "size": <æ€»å¤§å°>,      // åˆå¹¶åçš„æ€»å¤§å°
        "flags": 7            // å¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œ
    }],
    ".load": [/* ... */],     // åˆå¹¶åçš„ .load èŠ‚å†…å®¹ï¼Œåº”è¯¥åªåŒ…å«æœºå™¨ç 
    "entry": <å…¥å£åœ°å€>        // ç¨‹åºçš„å…¥å£ç‚¹
}
```

è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

> [!TIP]
> åœ¨å®ç°é“¾æ¥å™¨çš„è¿‡ç¨‹ä¸­ï¼Œä¸€ç§å¯è¡Œçš„æ€è·¯æ˜¯é‡‡ç”¨å¤šéæ‰«æçš„æ–¹æ³•ï¼š
> 1. ç¬¬ä¸€æ¬¡æ‰«æï¼šåˆå¹¶æ‰€æœ‰èŠ‚çš„å†…å®¹
> 2. ç¬¬äºŒæ¬¡æ‰«æï¼šæ”¶é›†å¹¶è§£ææ‰€æœ‰ç¬¦å·
> 3. ç¬¬ä¸‰æ¬¡æ‰«æï¼šä»ä¸Šåˆ°ä¸‹ä¾æ¬¡å¤„ç†æ‰€æœ‰é‡å®šä½é¡¹ï¼Œå°†è®¡ç®—å‡ºçš„åœ°å€å›å¡«
> 
> æœ€åç”Ÿæˆç¨‹åºå¤´ï¼Œå¹¶è®¾ç½®å…¥å£ç‚¹ï¼Œå¾—åˆ°æœ€ç»ˆçš„ `FLEObject`ã€‚
> 
> ä½ ä¹Ÿå¯ä»¥æ€è€ƒæœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ³•ã€‚

åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œå»ºè®®å…ˆå¤„ç†åªæœ‰ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„ç®€å•æƒ…å†µã€‚ä½ å¯ä»¥ä½¿ç”¨ `readfle` å·¥å…·æ£€æŸ¥è¾“å‡ºæ–‡ä»¶çš„æ ¼å¼æ˜¯å¦æ­£ç¡®å¹¶æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼ˆæ¯”å¦‚èŠ‚çš„åˆå¹¶è¿‡ç¨‹ã€ç¬¦å·çš„æ–°åœ°å€ã€é‡å®šä½çš„å¤„ç†è¿‡ç¨‹ï¼‰ä¹Ÿä¼šå¯¹è°ƒè¯•å¾ˆæœ‰å¸®åŠ©ã€‚

å®Œæˆä¹‹åï¼Œä½ å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æµ‹è¯•ä½ çš„é“¾æ¥å™¨ï¼š

```bash
make test_2
```

## ä»»åŠ¡ä¸‰ï¼šå®ç°ç›¸å¯¹é‡å®šä½

åœ¨ä»»åŠ¡äºŒä¸­ï¼Œæˆ‘ä»¬å¤„ç†äº†æœ€ç®€å•çš„é‡å®šä½ç±»å‹ - è®¿é—®å…¨å±€å˜é‡æ—¶ä½¿ç”¨çš„ç»å¯¹åœ°å€ã€‚ä½†åœ¨å®é™…ç¨‹åºä¸­ï¼Œæœ€å¸¸è§çš„å…¶å®æ˜¯å‡½æ•°è°ƒç”¨ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­:

```c
// lib.c
int add(int x) {    // ä¸€ä¸ªç®€å•çš„å‡½æ•°
    return x + 1;
}

// main.c
extern int add(int);  // å£°æ˜ï¼šadd å‡½æ•°åœ¨åˆ«å¤„å®šä¹‰

int main() {
    return add(41);   // è°ƒç”¨ add å‡½æ•°
}
```

> [!NOTE]
> ä»ä»»åŠ¡ä¸‰å¼€å§‹ï¼Œæˆ‘ä»¬å¼€å§‹åŒ…å« [`tests/common/minilibc.h`](./tests/common/minilibc.h) åº“ï¼Œè¿™ä¸ªåº“æ¨¡æ‹Ÿäº†æ ‡å‡† C åº“çš„ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œæä¾›é¢„å®šä¹‰çš„ `_start` å‡½æ•°ï¼Œä¼šå°†æ§åˆ¶æƒäº¤ç»™ `main` å‡½æ•°ã€‚

ç¼–è¯‘å™¨ä¼šå°†è¿™äº›æºæ–‡ä»¶ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ã€‚è¿™ä¸ªå‡½æ•°è°ƒç”¨åœ¨æˆ‘ä»¬çš„ FLE æ ¼å¼ä¸­ï¼Œè¡¨ç¤ºä¸º:

```json5
{
    "type": ".obj",
    ".text": [
        "ğŸ“¤: main 20 0",
        "ğŸ”¢: f3 0f 1e fa 55 48 89 e5 bf 29 00 00 00 e8",
        "â“: .rel(add - 4)",  // é“¾æ¥å™¨éœ€è¦å°†è¿™é‡Œæ›¿æ¢æˆ call æŒ‡ä»¤çš„ç›®æ ‡åœ°å€
        "ğŸ”¢: 5d c3"
    ]
}
```

> [!TIP]
> x86-64 çš„ call æŒ‡ä»¤æ ¼å¼æ˜¯ï¼š
> - ä¸€ä¸ªå­—èŠ‚çš„æ“ä½œç ï¼ˆ0xE8ï¼‰
> - å››ä¸ªå­—èŠ‚çš„ç›¸å¯¹åç§»é‡ï¼ˆå°ç«¯åºï¼‰

å½“è¿™ä¸ªæ–‡ä»¶è¢«åŠ è½½åˆ°å†…å­˜æ—¶ï¼Œé‡å®šä½ä¿¡æ¯ä¼šè¢«è§£ææˆä¸€ä¸ª `Relocation` ç»“æ„:

```cpp
Relocation {
    .type = RelocationType::R_X86_64_PC32,  // 32ä½ç›¸å¯¹å¯»å€
    .offset = 14,                           // é‡å®šä½ä½ç½®ï¼ˆåœ¨èŠ‚å†…çš„åç§»ï¼‰
    .symbol = "add",                        // ç›®æ ‡ç¬¦å·
    .addend = -4                            // åç§»é‡è°ƒæ•´å€¼
}
```

æ³¨æ„è¿™é‡Œçš„ `.rel(add - 4)` è¡¨ç¤ºä¸€ä¸ªç›¸å¯¹é‡å®šä½ï¼ˆ`R_X86_64_PC32` ç±»å‹ï¼‰ã€‚ä¸ä»»åŠ¡äºŒä¸­çš„ç»å¯¹é‡å®šä½ä¸åŒï¼Œè¿™é‡Œå­˜å‚¨çš„ä¸æ˜¯å‡½æ•°çš„ç»å¯¹åœ°å€ï¼Œè€Œæ˜¯"è¦è·³å¤šè¿œ"ã€‚è¿™ç§è®¾è®¡æœ‰ä¸¤ä¸ªé‡è¦çš„ä¼˜ç‚¹ï¼š

1. ä»£ç å¯ä»¥åŠ è½½åˆ°å†…å­˜çš„ä»»ä½•ä½ç½®ï¼Œå› ä¸ºè·³è½¬è·ç¦»æ˜¯ç›¸å¯¹çš„
2. æŒ‡ä»¤æ›´çŸ­ï¼Œå› ä¸ºåç§»é‡åªéœ€è¦ 32 ä½ï¼ˆè€Œä¸æ˜¯å®Œæ•´çš„ 64 ä½åœ°å€ï¼‰

è®¡ç®—å…¬å¼å¾ˆç®€å•ï¼š

```
åç§»é‡ = ç›®æ ‡åœ°å€ + é™„åŠ å€¼ - é‡å®šä½ä½ç½®
      = S + A - P
```

å…¶ä¸­ï¼š
- S (Symbol)ï¼šç›®æ ‡ç¬¦å·çš„åœ°å€ï¼ˆæ¯”å¦‚ add å‡½æ•°çš„ä½ç½®ï¼‰
- A (Addend)ï¼šé‡å®šä½é¡¹ä¸­çš„é™„åŠ å€¼ï¼ˆé€šå¸¸æ˜¯ -4ï¼‰
- P (Place)ï¼šé‡å®šä½ä½ç½®çš„åœ°å€ï¼ˆcall æŒ‡ä»¤æ“ä½œæ•°çš„ä½ç½®ï¼‰

æ¯”å¦‚ï¼Œå¦‚æœï¼š
- add å‡½æ•°åœ¨ 0x4000A0
- call æŒ‡ä»¤çš„æ“ä½œæ•°åœ¨ 0x400035
- é™„åŠ å€¼æ˜¯ -4

é‚£ä¹ˆï¼š
```
åç§»é‡ = 0x4000A0 + (-4) - 0x400035 = 0x67
```

æœ€ç»ˆçš„æœºå™¨ç å°±æ˜¯ï¼š
```
E8 67 00 00 00   ; call add
```

> [!TIP]
> ä¸ºä»€ä¹ˆéœ€è¦ addendï¼ˆé™„åŠ å€¼ï¼‰ï¼Ÿè¿™ä¸ x86-64 çš„ç¨‹åºè®¡æ•°å™¨ %rip çš„å·¥ä½œæ–¹å¼æœ‰å…³ï¼š
> 1. call æŒ‡ä»¤ä¸­çš„åç§»é‡æ˜¯ç›¸å¯¹äº %rip çš„ï¼Œè€Œ %rip æ€»æ˜¯æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤
> 2. æ‰€ä»¥å½“ CPU æ‰§è¡Œåˆ°è¿™ä¸ª call æŒ‡ä»¤æ—¶ï¼š
>    - %rip å·²ç»æŒ‡å‘äº†ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ˆå½“å‰ä½ç½® + 5ï¼‰
>    - è€Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ä»å½“å‰ä½ç½®åˆ°ç›®æ ‡çš„è·ç¦»
> 3. å› æ­¤éœ€è¦ addend = -4 æ¥ä¿®æ­£è¿™ä¸ªå·®å¼‚ï¼š
>    - å®é™…è·ç¦» = ç›®æ ‡åœ°å€ - å½“å‰åœ°å€
>    - CPU è®¡ç®— = ç›®æ ‡åœ°å€ - (%rip = å½“å‰åœ°å€ + 5)
>    - æ‰€ä»¥åç§»é‡ = å®é™…è·ç¦» - 4ï¼Œå³éœ€è¦ addend = -4

è¦å®ç°è¿™ç§é‡å®šä½ï¼Œä½ éœ€è¦ï¼š

1. è¯†åˆ« `Relocation` ç»“æ„ä¸­çš„ `R_X86_64_PC32` ç±»å‹
2. ä»ç¬¦å·è¡¨ä¸­æ‰¾åˆ°ç›®æ ‡ç¬¦å·çš„åœ°å€ï¼ˆSï¼‰
3. ä»é‡å®šä½é¡¹çš„ `offset` å­—æ®µè·å–é‡å®šä½ä½ç½®ï¼ˆPï¼‰
4. ä½¿ç”¨ `addend` å­—æ®µä½œä¸ºé™„åŠ å€¼ï¼ˆAï¼‰
5. è®¡ç®—åç§»é‡ï¼šS + A - P
6. å°† 32 ä½çš„åç§»é‡å†™å…¥åˆ° `FLESection` çš„ `data` æ•°ç»„ä¸­ï¼ˆæ³¨æ„å­—èŠ‚åºï¼‰

> [!TIP]
> è°ƒè¯•ç›¸å¯¹é‡å®šä½æ—¶ï¼Œæ‰“å°ä»¥ä¸‹ä¿¡æ¯ä¼šå¾ˆæœ‰å¸®åŠ©ï¼š
> - ç›®æ ‡ç¬¦å·çš„åœ°å€ï¼ˆSï¼‰
> - é‡å®šä½ä½ç½®çš„åœ°å€ï¼ˆPï¼‰
> - è®¡ç®—å¾—åˆ°çš„åç§»é‡
> - æœ€ç»ˆå†™å…¥çš„å­—èŠ‚

### éªŒè¯

è¿è¡Œæµ‹è¯•ï¼š

```bash
make test_3
```

## ä»»åŠ¡å››ï¼šå¤„ç†ç¬¦å·å†²çªå’Œè®¿é—®é™åˆ¶

åœ¨å‰é¢çš„ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ªç¬¦å·åªåœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰ã€‚ä½†åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°åŒåç¬¦å·ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```c
// config.c
int debug_level = 0;  // é»˜è®¤é…ç½®

// main.c
int debug_level = 1;  // è‡ªå®šä¹‰é…ç½®
```

è¿™æ—¶é“¾æ¥å™¨è¯¥æ€ä¹ˆåŠï¼Ÿåº”è¯¥ç”¨å“ªä¸ª `debug_level`ï¼Ÿ

é™¤äº†å¤„ç†åŒåç¬¦å·çš„é—®é¢˜ï¼Œé“¾æ¥å™¨è¿˜éœ€è¦æ­£ç¡®å¤„ç†ç¬¦å·çš„å¯è§æ€§ã€‚åœ¨Cè¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ `static` å…³é”®å­—å°†ç¬¦å·å£°æ˜ä¸ºå±€éƒ¨çš„ï¼š

```c
// foo.c
static int counter = 0;  // å±€éƒ¨ç¬¦å·ï¼Œåªåœ¨æœ¬æ–‡ä»¶å¯è§

// main.c
extern int counter;      // é”™è¯¯ï¼šä¸èƒ½è®¿é—®å…¶ä»–æ–‡ä»¶çš„å±€éƒ¨ç¬¦å·ï¼
```

è¿™ç§è®¿é—®åº”è¯¥åœ¨é“¾æ¥æ—¶è¢«å‘ç°å¹¶æŠ¥é”™ï¼Œå› ä¸ºè¿™è¿åäº†å±€éƒ¨ç¬¦å·çš„è®¿é—®é™åˆ¶ã€‚

ä¸ºäº†è§£å†³ç¬¦å·å†²çªå’Œå¯è§æ€§é—®é¢˜ï¼ŒCè¯­è¨€æä¾›äº†å‡ ç§ä¸åŒ"å¼ºåº¦"çš„ç¬¦å·ï¼š

- å¼ºç¬¦å·ï¼ˆGLOBALï¼‰ï¼šæ™®é€šçš„å…¨å±€ç¬¦å·
- å¼±ç¬¦å·ï¼ˆWEAKï¼‰ï¼šå¯ä»¥è¢«è¦†ç›–çš„å¤‡é€‰é¡¹
- å±€éƒ¨ç¬¦å·ï¼ˆLOCALï¼‰ï¼šåªåœ¨å®šä¹‰å®ƒçš„ç›®æ ‡æ–‡ä»¶å†…å¯è§

æœ€å¸¸è§çš„ç”¨æ³•æ˜¯ï¼Œç”¨å¼±ç¬¦å·æ¥æä¾›å¯è¦†ç›–çš„é»˜è®¤å®ç°ï¼š

```c
// logger.c
__attribute__((weak))        // æ ‡è®°ä¸ºå¼±ç¬¦å·
void init_logger() {         // é»˜è®¤çš„åˆå§‹åŒ–å‡½æ•°
    // ä½¿ç”¨é»˜è®¤é…ç½®
}

// main.c
void init_logger() {         // å¼ºç¬¦å·ä¼šè¦†ç›–é»˜è®¤å®ç°
    // ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
}
```

åœ¨ FLE æ ¼å¼ä¸­ï¼Œå¼±ç¬¦å·ç”¨ ğŸ“ è¡¨ç¤ºï¼š

```json5
{
    "type": ".obj",
    ".text": [
        "ğŸ“: init_logger 20 0",  // å¼±ç¬¦å·
        "ğŸ”¢: 55 48 89 e5 ..."
    ]
}
```

é“¾æ¥æ—¶ï¼Œç¬¦å·å†²çªçš„å¤„ç†è§„åˆ™å¾ˆç®€å•ï¼š

1. å¼ºç¬¦å·å¿…é¡»å”¯ä¸€ï¼Œå¦åˆ™æŠ¥é”™ï¼š
```c
// a.c
int max(int x, int y) { return x > y ? x : y; }

// b.c
int max(int x, int y) { return x > y ? x : y; }  // é”™è¯¯ï¼šé‡å¤å®šä¹‰ï¼
```

2. å¼ºç¬¦å·ä¼˜å…ˆäºå¼±ç¬¦å·ï¼š
```c
// lib.c
__attribute__((weak))
void init() { /* é»˜è®¤å®ç° */ }

// main.c
void init() { /* è‡ªå®šä¹‰å®ç°ï¼Œä¼šè¦†ç›–é»˜è®¤ç‰ˆæœ¬ */ }
```

3. å¤šä¸ªå¼±ç¬¦å·æ—¶éšæœºé€‰æ‹©ï¼š
```c
// a.c
__attribute__((weak))
int debug = 0;

// b.c
__attribute__((weak))
int debug = 1;
```

è¦å®ç°è¿™äº›è§„åˆ™å’Œè®¿é—®é™åˆ¶ï¼Œä½ éœ€è¦ï¼š

1. æ”¶é›†æ‰€æœ‰ç¬¦å·æ—¶ï¼Œæ£€æŸ¥æ¯ä¸ªç¬¦å·çš„ `SymbolType`
2. ç”¨ `std::map<std::string, Symbol>` æŒ‰åå­—åˆ†ç»„ç¬¦å·
3. å½“é‡åˆ°åŒåç¬¦å·æ—¶ï¼š
   - å¦‚æœéƒ½æ˜¯å¼ºç¬¦å·ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼š`"Multiple definition of strong symbol: " + sym.name`
   - å¦‚æœä¸€ä¸ªå¼ºä¸€ä¸ªå¼±ï¼Œä¿ç•™å¼ºç¬¦å·
   - å¦‚æœéƒ½æ˜¯å¼±ç¬¦å·ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª
4. å¯¹äºå±€éƒ¨ç¬¦å·ï¼ˆLOCALï¼‰ï¼š
   - è®°å½•å®ƒä»¬æ‰€å±çš„ç›®æ ‡æ–‡ä»¶
   - å½“å…¶ä»–æ–‡ä»¶å°è¯•å¼•ç”¨å±€éƒ¨ç¬¦å·æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼š`"Undefined symbol: " + sym.name`
   - æ³¨æ„ï¼šåŒåçš„å±€éƒ¨ç¬¦å·å¦‚æœåœ¨ä¸åŒæ–‡ä»¶ä¸­æ˜¯å…è®¸çš„ï¼Œå› ä¸ºå®ƒä»¬çš„ä½œç”¨åŸŸæ˜¯ç‹¬ç«‹çš„

> [!IMPORTANT]
> åœ¨å®é™…ä»£ç ä¸­ï¼Œé™¤äº†æ˜¾å¼å£°æ˜çš„åŒåå±€éƒ¨ç¬¦å·ä¹‹å¤–ï¼Œä½ è¿˜ä¼šé‡åˆ°ä¸€äº›ç‰¹æ®Šçš„åŒåå±€éƒ¨ç¬¦å·æƒ…å†µã€‚ä¾‹å¦‚ä¸åŒæ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²å­—é¢é‡å¯èƒ½ä¼šç”ŸæˆåŒåçš„å±€éƒ¨ç¬¦å·ã€‚
>
> ä¸ºäº†å¤„ç†è¿™äº›æƒ…å†µï¼Œä½ éœ€è¦æƒ³åŠæ³•å°†æ¥è‡ªä¸åŒæ–‡ä»¶çš„åŒåå±€éƒ¨ç¬¦å·åŒºåˆ†å¼€æ¥ã€‚å»ºè®®ï¼š
> - åœ¨å±€éƒ¨ç¬¦å·åå‰æ·»åŠ æ–‡ä»¶åä½œä¸ºå‰ç¼€
> - ä½¿ç”¨åŒ…å«å‰ç¼€çš„å®Œæ•´ç¬¦å·åè¿›è¡Œé‡å®šä½æŸ¥æ‰¾
> - åœ¨è°ƒè¯•è¾“å‡ºä¸­æ˜¾ç¤ºå®Œæ•´çš„ç¬¦å·åï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

> [!NOTE]
> å¯¹äºéœ€è¦æŠ¥é”™çš„æƒ…å†µï¼Œä½ å¯ä»¥ï¼š
> - é€šè¿‡ `throw std::runtime_error("é”™è¯¯ä¿¡æ¯")` æŠ›å‡ºå¼‚å¸¸ï¼Œå®éªŒæ¡†æ¶ä¼šè‡ªåŠ¨æ•è·å¹¶è¾“å‡ºé”™è¯¯ä¿¡æ¯åˆ°æ ‡å‡†é”™è¯¯æµ
> - æˆ–è€…ç›´æ¥å‘æ ‡å‡†é”™è¯¯æµè¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œç„¶åè°ƒç”¨ `exit(1)` ä¸­æ­¢ç¨‹åº
>
> æˆ‘ä»¬çš„æµ‹è¯•è„šæœ¬é‡‡ç”¨å®½æ¾çš„åŒ¹é…æ–¹å¼ï¼Œåªè¦é”™è¯¯ä¿¡æ¯ä¸­åŒ…å«ç¬¦åˆæ ¼å¼çš„ä¸€è¡Œå³å¯é€šè¿‡æµ‹è¯•ã€‚

å®Œæˆåï¼Œä½ çš„é“¾æ¥å™¨å°±èƒ½æ­£ç¡®å¤„ç†ç¬¦å·å†²çªå’Œè®¿é—®é™åˆ¶äº†ã€‚è¿è¡Œæµ‹è¯•æ¥éªŒè¯ï¼š

```bash
make test_4
```

## ä»»åŠ¡äº”ï¼šå¤„ç† 64 ä½åœ°å€

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¤„ç†çš„éƒ½æ˜¯ 32 ä½çš„åœ°å€ï¼ˆ`R_X86_64_32` å’Œ `R_X86_64_PC32`ï¼‰ã€‚ä½†åœ¨ 64 ä½ç³»ç»Ÿä¸­ï¼Œæœ‰æ—¶æˆ‘ä»¬éœ€è¦å®Œæ•´çš„ 64 ä½åœ°å€ã€‚æ¯”å¦‚ï¼š

```c
// ä¸€ä¸ªå…¨å±€æ•°ç»„
int numbers[] = {1, 2, 3, 4};

// ä¸€ä¸ªæŒ‡å‘è¿™ä¸ªæ•°ç»„çš„æŒ‡é’ˆ
int *ptr = &numbers[0];  // éœ€è¦å®Œæ•´çš„ 64 ä½åœ°å€ï¼
```

ä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦ 64 ä½åœ°å€ï¼Ÿå› ä¸ºï¼š

1. æŒ‡é’ˆæœ¬èº«æ˜¯ 64 ä½çš„ï¼ˆ8 å­—èŠ‚ï¼‰
2. ç¨‹åºå¯èƒ½è¢«åŠ è½½åˆ°é«˜åœ°å€åŒºåŸŸ
3. 32 ä½åœ°å€æœ€å¤šåªèƒ½è®¿é—® 4GB ç©ºé—´

è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„é‡å®šä½ç±»å‹ï¼ˆ`R_X86_64_64`ï¼‰ï¼š

```json5
{
    "type": ".obj",
    ".data": [
        "ğŸ“¤: numbers 16", // numbers æ•°ç»„
        "ğŸ”¢: 01 00 00 00", // 1
        "ğŸ”¢: 02 00 00 00", // 2
        "ğŸ”¢: 03 00 00 00", // 3
        "ğŸ”¢: 04 00 00 00"  // 4
    ],
    ".data.rel.local": [
        "ğŸ“¤: ptr 8",
        "â“: .abs64(numbers + 0)" // éœ€è¦ numbers çš„å®Œæ•´åœ°å€
    ]
    ...
}
```

æ³¨æ„é‚£ä¸ª `.abs64` â€”â€” è¿™æ˜¯ä¸€ä¸ªæ–°çš„é‡å®šä½ç±»å‹ï¼ˆ`R_X86_64_64`ï¼‰ï¼Œå®ƒå‘Šè¯‰é“¾æ¥å™¨ï¼š"åœ¨è¿™é‡Œå¡«å…¥ç¬¦å·çš„å®Œæ•´ 64 ä½åœ°å€"ã€‚

å½“è¿™ä¸ªé‡å®šä½è¢«åŠ è½½åˆ°å†…å­˜æ—¶ï¼Œå®ƒä¼šè¢«è§£ææˆï¼š

```cpp
Relocation {
    .type = RelocationType::R_X86_64_64,  // 64ä½ç»å¯¹å¯»å€
    .offset = 0,                          // é‡å®šä½ä½ç½®
    .symbol = "numbers",                  // ç›®æ ‡ç¬¦å·
    .addend = 0                          // åç§»é‡
}
```

ä½ çš„ä»»åŠ¡æ˜¯æ”¯æŒè¿™ç§é‡å®šä½ã€‚å¤„ç†è¿™ç§é‡å®šä½æ—¶ï¼Œè®¡ç®—å…¬å¼ä¸ 32 ä½ç»å¯¹å¯»å€ç›¸åŒï¼Œä½†å†™å…¥æ—¶éœ€è¦å†™å…¥å®Œæ•´çš„ 8 å­—èŠ‚

ä½ å¯èƒ½è¿˜éœ€è¦æ³¨æ„ï¼š

1. è€ƒè™‘å­—èŠ‚åºï¼ˆx86 æ˜¯å°ç«¯ï¼‰
2. åœ°å€è¦åŠ ä¸ŠåŸºåœ°å€ï¼ˆ0x400000ï¼‰

æç¤ºï¼š

1. ä½¿ç”¨ 64 ä½æ•´æ•°å­˜å‚¨åœ°å€
2. å°å¿ƒæ•´æ•°æº¢å‡º
3. ç”¨ readfle æ£€æŸ¥è¾“å‡º

å®Œæˆåï¼Œä½ çš„é“¾æ¥å™¨å°±èƒ½å¤„ç† 64 ä½åœ°å€äº†ã€‚è¿è¡Œæµ‹è¯•æ¥éªŒè¯ï¼š

```bash
make test_5
```

## ä»»åŠ¡å…­ï¼šåˆ†ç¦»ä»£ç å’Œæ•°æ®

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰ç¨‹åºçš„æ‰€æœ‰æ•°æ®éƒ½æ”¾åœ¨ä¸€ä¸ªæ®µä¸­ã€‚è¿™çœ‹èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œä½†æ­£å¦‚æˆ‘ä»¬åœ¨æ±‡ç¼–ç« æ‰€å­¦åˆ°çš„é‚£æ ·ï¼Œè¿™ç»™äº†æ”»å‡»è€…ç¯¡æ”¹ä»£ç çš„æœºä¼šã€‚æ¯”å¦‚ï¼š

```c
void hack() {
    // 1. ä¿®æ”¹ä»£ç 
    void* code = (void*)hack;
    *(char*)code = 0x90;     // å¦‚æœä»£ç æ®µå¯å†™ï¼Œç¨‹åºå¯ä»¥è¢«ç¯¡æ”¹ï¼

    // 2. æ‰§è¡Œæ•°æ®
    char shellcode[] = {...}; // ä¸€äº›æ¶æ„ä»£ç 
    ((void(*)())shellcode)(); // å¦‚æœæ•°æ®æ®µå¯æ‰§è¡Œï¼Œè¿™å°±æ˜¯æ¼æ´ï¼
}
```

ä¸ºäº†é˜²æ­¢è¿™äº›æ”»å‡»ï¼Œç°ä»£ç³»ç»Ÿé‡‡ç”¨å†…å­˜åˆ†æ®µä¿æŠ¤æœºåˆ¶ã€‚åœ¨ FLE æ ¼å¼ä¸­ï¼Œç¼–è¯‘å™¨å·²ç»å¸®æˆ‘ä»¬å°†ä»£ç åˆ’åˆ†ä¸ºä¸åŒçš„èŠ‚ï¼š

```json5
{
  "type": ".obj",
  ".text": [
    "ğŸ“¤: main 40 0",
    "ğŸ”¢: f3 0f 1e fa 55 48 89 e5 be 00 00 00 00 48 8d 05",
    "â“: .rel(.rodata - 4)",
    "ğŸ”¢: 48 89 c7 b8 00 00 00 00 e8",
    "â“: .rel(print - 4)",
    "ğŸ”¢: b8 00 00 00 00 5d c3"
  ],
  ".data": [
    "ğŸ“¤: counter 4 0",
    "ğŸ”¢: 03 00 00 00" // å·²åˆå§‹åŒ–æ•°æ®
  ],
  ".bss": [
    "ğŸ“¤: buffer 4096 0" // æœªåˆå§‹åŒ–æ•°æ®ï¼Œåªè®°å½•å¤§å°
  ],
  ".rodata": [
    "ğŸ·ï¸: .rodata 0 0",
    "ğŸ”¢: 48 65 6c 6c 6f 00" // "Hello"
  ]
}
```

è¿™äº›èŠ‚éœ€è¦è¢«æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œæ¯ç§ç±»å‹çš„èŠ‚éƒ½éœ€è¦ä¸åŒçš„è®¿é—®æƒé™ï¼š
- `.text` èŠ‚ï¼šéœ€è¦åªè¯»ä¸”å¯æ‰§è¡Œæƒé™ï¼Œå­˜æ”¾ç¨‹åºä»£ç 
- `.rodata` èŠ‚ï¼šéœ€è¦åªè¯»æƒé™ï¼Œå­˜æ”¾å¸¸é‡æ•°æ®
- `.data` èŠ‚ï¼šéœ€è¦è¯»å†™æƒé™ï¼Œå­˜æ”¾å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡
- `.bss` èŠ‚ï¼šéœ€è¦è¯»å†™æƒé™ï¼Œå­˜æ”¾æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡

é“¾æ¥å™¨éœ€è¦ï¼š
1. ä¿æŒä¸åŒèŠ‚çš„ç‹¬ç«‹æ€§ï¼Œä¸è¦åˆå¹¶
2. ä¸ºæ¯ä¸ªèŠ‚åˆ›å»ºå¯¹åº”çš„ç¨‹åºå¤´ï¼Œè®¾ç½®æ­£ç¡®çš„æƒé™ï¼š
   - `.text`: r-xï¼ˆè¯»/æ‰§è¡Œï¼‰
   - `.rodata`: r--ï¼ˆåªè¯»ï¼‰
   - `.data`: rw-ï¼ˆè¯»/å†™ï¼‰
   - `.bss`: rw-ï¼ˆè¯»/å†™ï¼‰
3. ä¼˜åŒ–å†…å­˜å¸ƒå±€ï¼š
   - ä¿è¯æ¯ä¸ªèŠ‚çš„èµ·å§‹åœ°å€ 4KB å¯¹é½
   - åˆç†å®‰æ’èŠ‚çš„é¡ºåºä»¥å‡å°‘å†…å­˜ç¢ç‰‡

> [!IMPORTANT]
> `.bss` èŠ‚åœ¨é“¾æ¥è¿‡ç¨‹ä¸­éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚åœ¨ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œ`.bss` èŠ‚å¹¶ä¸å®é™…å­˜å‚¨æ•°æ®ï¼Œè€Œåªåœ¨èŠ‚å¤´ä¸­è®°å½•æ‰€éœ€çš„å¤§å°ã€‚è¿™æ˜¯å› ä¸º `.bss` èŠ‚ä¸“é—¨ç”¨äºå­˜æ”¾æœªåˆå§‹åŒ–æˆ–åˆå§‹åŒ–ä¸º 0 çš„å…¨å±€å˜é‡ï¼Œæ²¡æœ‰å¿…è¦åœ¨æ–‡ä»¶ä¸­å®é™…å­˜å‚¨è¿™äº› 0 å€¼ã€‚
>
> é“¾æ¥å™¨åœ¨å¤„ç† `.bss` èŠ‚æ—¶ï¼Œä¸»è¦å·¥ä½œæ˜¯è®¡ç®—ç¬¦å·çš„æ–°ä½ç½®ã€‚ç”±äºç¬¦å·åœ¨ `.bss` èŠ‚ä¸­çš„æ’åˆ—å¯èƒ½å¹¶ä¸æ˜¯è¿ç»­çš„ï¼Œå› æ­¤æ¯ä¸ªè¾“å…¥æ–‡ä»¶çš„ç¬¦å·è¡¨éƒ½ä¼šæ˜¾å¼è®°å½•è¯¥ç¬¦å·åœ¨å…¶æ‰€å± `.bss` èŠ‚ä¸­çš„ä½ç½®ï¼ˆå³åç§»é‡ `offset`ï¼‰ã€‚é“¾æ¥å™¨åœ¨åˆå¹¶æ‰€æœ‰è¾“å…¥æ–‡ä»¶çš„èŠ‚æ—¶ï¼Œéœ€è¦æ ¹æ®å„ä¸ªèŠ‚åœ¨æœ€ç»ˆæ–‡ä»¶ä¸­çš„ä½ç½®ä»¥åŠæ¯ä¸ªç¬¦å·çš„åç§»é‡ï¼Œè®¡ç®—ç¬¦å·çš„æ–°åœ°å€ã€‚
>
> è¿™äº›æ–°è®¡ç®—å‡ºçš„ä½ç½®ä¼šè¢«ç”¨äºé‡å®šä½æ—¶çš„åœ°å€è®¡ç®—ï¼Œä½† `.bss` èŠ‚æœ¬èº«åœ¨æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ä»ç„¶ä¸åŒ…å«å®é™…æ•°æ®ã€‚æ“ä½œç³»ç»Ÿä¼šåœ¨åŠ è½½ç¨‹åºæ—¶ï¼Œè‡ªåŠ¨å°† `.bss` èŠ‚å¯¹åº”çš„å†…å­˜åŒºåŸŸåˆå§‹åŒ–ä¸º 0ã€‚

å®Œæˆåï¼Œä½ çš„é“¾æ¥å™¨å°±èƒ½ç”Ÿæˆå…·æœ‰æ­£ç¡®å†…å­˜å¸ƒå±€å’Œè®¿é—®æƒé™çš„å¯æ‰§è¡Œæ–‡ä»¶äº†ã€‚è¿è¡Œæµ‹è¯•æ¥éªŒè¯ï¼š

```bash
make test_6
```

## ä»»åŠ¡ä¸ƒï¼šéªŒè¯ä¸æ€»ç»“

æ­å–œä½ å®Œæˆäº†æ‰€æœ‰åŸºç¡€ä»»åŠ¡ï¼ç°åœ¨è®©æˆ‘ä»¬éªŒè¯æ•´ä¸ªé“¾æ¥å™¨çš„åŠŸèƒ½ã€‚

### å®Œæ•´æµ‹è¯•

```bash
make test
```

ä½ åº”è¯¥çœ‹åˆ°ï¼š

```
Preparing FLE Tools...
âœ“ FLE Tools compiled successfully
Preparing minilibc...
âœ“ minilibc compiled successfully

Running 12 test cases...

âœ“ nm Tool Test [2/2]: Passed
âœ“ Single File Test [3/3]: Passed
âœ“ Absolute Addressing Test [3/3]: Passed
âœ“ Absolute + Relative Addressing Test [4/4]: Passed
âœ“ Position Independent Executable Test [5/5]: Passed
âœ“ Strong Symbol Conflict Test [3/3]: Passed
âœ“ Weak Symbol Override Test [4/4]: Passed
âœ“ Multiple Weak Symbol Warning [5/5]: Passed
âœ“ Local Symbol Access Test [7/7]: Passed
âœ“ 64-bit Absolute Relocation Test [3/3]: Passed
âœ“ BSS Section Linking Test [5/5]: Passed
âœ“ Section Permission Control Test [10/10]: Passed
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ Test Case                           â”ƒ Result â”ƒ  Time â”ƒ     Score â”ƒ Message             â”ƒ
â”¡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”©
â”‚ nm Tool Test                        â”‚  PASS  â”‚ 0.36s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Single File Test                    â”‚  PASS  â”‚ 0.27s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Absolute Addressing Test            â”‚  PASS  â”‚ 0.29s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Absolute + Relative Addressing Test â”‚  PASS  â”‚ 0.60s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Position Independent Executable     â”‚  PASS  â”‚ 0.93s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Test                                â”‚        â”‚       â”‚           â”‚                     â”‚
â”‚ Strong Symbol Conflict Test         â”‚  PASS  â”‚ 0.70s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Weak Symbol Override Test           â”‚  PASS  â”‚ 0.78s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Multiple Weak Symbol Warning        â”‚  PASS  â”‚ 0.85s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Local Symbol Access Test            â”‚  PASS  â”‚ 0.46s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ 64-bit Absolute Relocation Test     â”‚  PASS  â”‚ 0.37s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ BSS Section Linking Test            â”‚  PASS  â”‚ 0.77s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Section Permission Control Test     â”‚  PASS  â”‚ 1.27s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ Total Score: 120.0/120.0 (100.0%)                                                      â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

```

### å®éªŒæŠ¥å‘Šè¦æ±‚

è¯·å‚è€ƒ[æŠ¥å‘Šæ¨¡æ¿é€šç”¨æŒ‡å—](./report/README.md)ï¼ŒåŸºäº[å®éªŒæŠ¥å‘Šæ¨¡æ¿](./report/report.md)ï¼Œå®Œæˆå®éªŒæŠ¥å‘Šã€‚

## å®Œæˆæœ¬å®éªŒ

### æäº¤

æˆ‘ä»¬ä½¿ç”¨ GitHub Classroom è¿›è¡Œæäº¤ï¼š

1. ç¡®ä¿æ‰€æœ‰ä»£ç å·²æäº¤åˆ°ä½ çš„ä»“åº“
2. GitHub Actions ä¼šè‡ªåŠ¨è¿è¡Œæµ‹è¯•
3. æˆ‘ä»¬å°†ä»¥ Actions çš„è¾“å‡ºä½œä¸ºè¯„åˆ†ä¾æ®

### è¯„åˆ†æ ‡å‡†

åˆ†æ•°ç”±æ­£ç¡®æ€§å¾—åˆ†å’Œä»£ç è´¨é‡å¾—åˆ†ç»„æˆï¼Œæ­£ç¡®æ€§å¾—åˆ†å  80%ï¼Œä»£ç è´¨é‡å¾—åˆ†å  20%ï¼Œå³ï¼š

$$
\text{æ€»åˆ†} = \frac{\text{æ­£ç¡®æ€§å¾—åˆ†}} {\text{æ­£ç¡®æ€§æ»¡åˆ†}} \times 80\% + \text{ä»£ç è´¨é‡å¾—åˆ†} \times 20\%
$$

å…¶ä¸­ï¼Œæ­£ç¡®æ€§å¾—åˆ†ç”± GitHub Classroom è‡ªåŠ¨è®¡ç®—ï¼Œä»£ç è´¨é‡å¾—åˆ†ç”±åŠ©æ•™æ ¹æ®ä»£ç é£æ ¼å’Œå®éªŒæŠ¥å‘Šè¯„åˆ†ï¼Œå…·ä½“è¡¡é‡å› ç´ ä¸ºï¼š

- ä»£ç é£æ ¼
  - ä»£ç è¡¨è¾¾èƒ½åŠ›å¼ºï¼Œé€»è¾‘æ¸…æ™°ï¼Œä»£ç ç®€æ´ï¼Œä»…åœ¨å¿…è¦æ—¶æ·»åŠ æ³¨é‡Š
  - ç§¯æä½¿ç”¨ C++ æ ‡å‡†åº“ï¼Œä¸é‡å¤é€ è½®å­
  - é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œè¿›è¡Œå¤šå±‚æ¬¡çš„é”™è¯¯æ£€æŸ¥
- å®éªŒæŠ¥å‘Š
  - å®éªŒæŠ¥å‘Šå†…å®¹å®Œæ•´ï¼Œæ ¼å¼è§„èŒƒï¼Œæ’ç‰ˆç¾è§‚
  - å®éªŒæŠ¥å‘Šå†…å®¹ä¸ä»£ç ä¸€è‡´ï¼Œæ— æ˜æ˜¾çŸ›ç›¾ï¼Œä½“ç°å‡ºå¯¹å®éªŒè€ƒå¯ŸçŸ¥è¯†çš„åŸºæœ¬äº†è§£
  - æœ‰æ€è€ƒï¼Œæœ‰æ€»ç»“ï¼Œæœ‰åæ€ï¼Œæœ‰åˆ›æ–°
  - å¯¹å®éªŒæä¾›æœ‰ä»·å€¼çš„åé¦ˆå’Œå»ºè®®

## è°ƒè¯•å»ºè®®

1. ä»”ç»†é˜…è¯» `include/fle.hpp` ä¸­çš„æ•°æ®ç»“æ„å®šä¹‰
2. ä½¿ç”¨ `readfle` å·¥å…·æŸ¥çœ‹ FLE æ–‡ä»¶çš„å†…å®¹
3. æµ‹è¯•ç”¨ä¾‹æä¾›äº†å¾ˆå¥½çš„å‚è€ƒå®ä¾‹
4. é“¾æ¥å™¨çš„è°ƒè¯•æŠ€å·§ï¼š
   - ä½¿ç”¨ `objdump` æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
   - æ‰“å°ä¸­é—´è¿‡ç¨‹çš„é‡è¦ä¿¡æ¯
   - åˆ†æ­¥éª¤å®ç°ï¼Œå…ˆç¡®ä¿åŸºæœ¬åŠŸèƒ½æ­£ç¡®

## è¿›é˜¶å†…å®¹

å®Œæˆäº†åŸºæœ¬ä»»åŠ¡åï¼Œä½ å¯ä»¥å°è¯•ï¼š

1. æ”¯æŒæ›´å¤šçš„é‡å®šä½ç±»å‹
2. å®ç°å…±äº«åº“åŠ è½½
3. æ·»åŠ ç¬¦å·ç‰ˆæœ¬æ§åˆ¶
4. ä¼˜åŒ–é“¾æ¥æ€§èƒ½
5. æ”¯æŒå¢é‡é“¾æ¥

è¿™äº›å†…å®¹ä¸ä¼šè®¡å…¥æœ¬æ¬¡å®éªŒçš„è¯„åˆ†ï¼Œå­¦æœ‰ä½™åŠ›çš„åŒå­¦å¯ä»¥è‡ªè¡Œæ¢ç´¢ã€‚

## å‚è€ƒèµ„æ–™

1. [CSAPP: Computer Systems A Programmer's Perspective](https://csapp.cs.cmu.edu/)
2. [System V ABI](https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf)
3. [Linkers & Loaders](https://linker.iecc.com/)
4. [How To Write Shared Libraries](https://www.akkadia.org/drepper/dsohowto.pdf)
